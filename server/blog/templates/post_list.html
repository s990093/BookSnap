{% extends 'base.html' %} {% block content %}
<!DOCTYPE html>
<html lang="en" class="dark">
  <head>
    <meta charset="UTF-8" />
    <title>Post List</title>
    <!-- 替換 Bootstrap 為 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        darkMode: "class",
        theme: {
          extend: {},
        },
      };
    </script>
    <style>
      .text-clamp {
        display: -webkit-box;
        -webkit-line-clamp: 5; /* 限制顯示五行 */
        -webkit-box-orient: vertical;
        overflow: hidden;
      }
    </style>
  </head>
  <body class="dark:bg-gray-900 text-gray-900 dark:text-white">
    <div
      id="toast"
      class="fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg opacity-0 pointer-events-none transition-all duration-300 ease-in-out"
    >
      Content copied successfully!
    </div>
    <div class="container mx-auto px-4 py-8">
      <h1 class="text-3xl font-bold mb-6 dark:text-white">All Posts</h1>

      <!-- 更新操作欄樣式 -->
      <div class="flex flex-col md:flex-row gap-4 mb-6 overflow-x-auto">
        <select
          id="userFilter"
          class="min-w-[120px] bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-700 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:focus:ring-blue-400 transition-colors duration-200"
        >
          <option value="">All Users</option>
          {% for user in users %}
          <option value="{{ user.id }}">{{ user.username }}</option>
          {% endfor %}
        </select>

        <select
          id="typeFilter"
          class="min-w-[120px] bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-700 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:focus:ring-blue-400 transition-colors duration-200"
        >
          <option value="">All Types</option>
          {% for type in post_types %}
          <option value="{{ type.name }}">{{ type.name }}</option>
          {% endfor %}
        </select>

        <select
          id="countryFilter"
          class="min-w-[120px] bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-700 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:focus:ring-blue-400 transition-colors duration-200"
        >
          <option value="">All Countries</option>
          {% for country in countries %}
          <option value="{{ country.name }}">{{ country.name }}</option>
          {% endfor %}
        </select>

        <select
          id="sortBy"
          class="min-w-[120px] bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-700 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:focus:ring-blue-400 transition-colors duration-200"
        >
          <option value="">Sort By</option>
          <option value="clear">Clear Sort</option>
          <option value="title">Title</option>
          <option value="author">Author</option>
          <option value="date">Date</option>
        </select>
      </div>

      <!-- 更新表格部分 -->
      <div
        class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6"
      >
        {% for post in posts %}
        <div
          class="bg-white dark:bg-gray-800 rounded-lg shadow-md overflow-hidden"
        >
          <!-- 图片轮播部分 -->
          {% if post.images.all %}
          <div class="relative">
            <div class="carousel-container relative h-48">
              {% for image in post.images.all %}
              <img
                src="{{ image.image.url }}"
                alt="{{ post.title }}"
                class="carousel-item absolute w-full h-full object-cover transition-opacity duration-500 {% if forloop.first %}opacity-100{% else %}opacity-0{% endif %}"
                data-index="{{ forloop.counter0 }}"
              />
              {% endfor %} {% if post.images.all|length > 1 %}
              <!-- 轮播控制按钮 -->
              <button
                class="carousel-prev absolute left-2 top-1/2 transform -translate-y-1/2 bg-black bg-opacity-50 text-white p-2 rounded-full"
              >
                <svg
                  class="w-4 h-4"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M15 19l-7-7 7-7"
                  />
                </svg>
              </button>
              <button
                class="carousel-next absolute right-2 top-1/2 transform -translate-y-1/2 bg-black bg-opacity-50 text-white p-2 rounded-full"
              >
                <svg
                  class="w-4 h-4"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M9 5l7 7-7 7"
                  />
                </svg>
              </button>
              <!-- 轮播指示器 -->
              <div
                class="absolute bottom-2 left-1/2 transform -translate-x-1/2 flex space-x-2"
              >
                {% for image in post.images.all %}
                <div
                  class="carousel-dot w-2 h-2 rounded-full bg-white {% if forloop.first %}opacity-100{% else %}opacity-50{% endif %}"
                  data-index="{{ forloop.counter0 }}"
                ></div>
                {% endfor %}
              </div>
              {% endif %}
            </div>
          </div>
          {% else %}
          <div
            class="w-full h-48 bg-gray-200 dark:bg-gray-700 flex items-center justify-center"
          >
            <span class="text-gray-400 dark:text-gray-500">No image</span>
          </div>
          {% endif %}

          <!-- 内容部分 -->
          <div class="p-4">
            <h2 class="text-lg font-bold text-gray-900 dark:text-white mb-2">
              {{ post.title }}
            </h2>

            <!-- 標籤區域 -->
            <div class="flex flex-wrap gap-2 mb-3">
              {% if post.post_type %}
              <span
                class="px-2 py-1 text-xs bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200 rounded-full"
              >
                {{ post.post_type.name }}
              </span>
              {% endif %} {% if post.country %}
              <span
                class="px-2 py-1 text-xs bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200 rounded-full"
              >
                {{ post.country.name }}
              </span>
              {% endif %} {% if post.author %}
              <span
                class="px-2 py-1 text-xs bg-purple-100 text-purple-800 dark:bg-purple-900 dark:text-purple-200 rounded-full"
              >
                {{ post.author.name }}
              </span>
              {% endif %}
            </div>

            <!-- 操作按鈕 -->
            <div class="mt-4 flex flex-nowrap justify-start gap-2 px-2">
              <button
                data-content="{{ post.content|escapejs }}"
                class="copy-content-btn flex-1 group relative inline-flex items-center justify-center gap-1.5 px-3 py-2 bg-green-500 text-white text-sm rounded-lg transition-all duration-300 ease-in-out hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 dark:focus:ring-offset-gray-800"
                aria-label="Copy Content"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  class="h-4 w-4"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke="currentColor"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3"
                  />
                </svg>
              </button>

              {% if post.images.all|length > 0 %}
              <button
                class="download-all-btn flex-1 group relative inline-flex items-center justify-center gap-1.5 px-3 py-2 bg-blue-500 text-white text-sm rounded-lg transition-all duration-300 ease-in-out hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 dark:focus:ring-offset-gray-800"
                data-images='[{% for image in post.images.all %}{"url": "{{ image.image.url }}", "filename": "{{ post.title }}_{{ forloop.counter }}.jpg"}{% if not forloop.last %},{% endif %}{% endfor %}]'
                aria-label="Download Images"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  class="h-4 w-4"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke="currentColor"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"
                  />
                </svg>
              </button>
              {% endif %}
            </div>
          </div>
        </div>
        {% endfor %}
      </div>

      <!-- 在表格後面添加 -->
      <div class="mt-6 text-center">
        {% if has_more %}
        <button
          id="loadMore"
          class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded-lg transition-all duration-300 ease-in-out transform hover:scale-105 active:scale-95"
        >
          Load More
        </button>
        {% endif %}
      </div>
    </div>

    <!-- JavaScript 保持不變 -->
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        // 主要功能類
        class PostManager {
          constructor() {
            this.initializeFilters();
            this.initializeLoadMore();
            this.initializeCopyContent();
            this.initializeCarousel();
            this.initializeDownload();
          }

          // 初始化所有過濾器
          initializeFilters() {
            const filters = {
              userFilter: "user",
              typeFilter: "type",
              countryFilter: "country",
              sortBy: "sort",
            };

            for (const [filterId, paramName] of Object.entries(filters)) {
              const element = document.getElementById(filterId);
              if (!element) continue;

              // 設置初始值
              const urlParams = new URLSearchParams(window.location.search);
              const currentValue = urlParams.get(paramName);
              if (currentValue) {
                element.value = currentValue;
              }

              // 添加事件監聽器
              element.addEventListener("change", () => {
                const currentUrl = new URL(window.location.href);

                if (filterId === "sortBy" && element.value === "clear") {
                  currentUrl.searchParams.delete("sort");
                  window.location.href = "/post-list/";
                  return;
                }

                if (element.value) {
                  currentUrl.searchParams.set(paramName, element.value);
                } else {
                  currentUrl.searchParams.delete(paramName);
                }

                window.location.href = currentUrl.toString();
              });
            }
          }

          // 初始化加載更多功能
          initializeLoadMore() {
            const loadMoreBtn = document.getElementById("loadMore");
            if (!loadMoreBtn) return;

            loadMoreBtn.addEventListener("click", () => {
              const currentUrl = new URL(window.location.href);
              const currentPage = parseInt(
                currentUrl.searchParams.get("page") || "1"
              );
              currentUrl.searchParams.set("page", currentPage + 1);
              window.location.href = currentUrl.toString();
            });

            // 如果是分頁加載，滾動到底部
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get("page")) {
              window.scrollTo(0, document.body.scrollHeight);
            }
          }

          // 初始化複製內文功能
          initializeCopyContent() {
            const copyContentBtn =
              document.querySelectorAll(".copy-content-btn");
            if (!copyContentBtn) return;

            copyContentBtn.forEach((button) => {
              button.addEventListener("click", async () => {
                const content = button
                  .getAttribute("data-content")
                  .replace(/\\u003C[^>]+\\u003E/g, "")
                  .replace(/\\u[\dA-F]{4}/gi, (match) => {
                    return String.fromCharCode(
                      parseInt(match.replace("\\u", ""), 16)
                    );
                  })
                  .replace(/\\n/g, "\n")
                  .replace(/\s*\n\s*/g, "\n\n")
                  .trim();

                try {
                  // 檢查是否支援 navigator.clipboard API
                  if (navigator.clipboard && window.isSecureContext) {
                    await navigator.clipboard.writeText(content);
                  } else {
                    // 後備方案：使用傳統的複製方法
                    const textArea = document.createElement("textarea");
                    textArea.value = content;
                    textArea.style.position = "fixed";
                    textArea.style.left = "-999999px";
                    textArea.style.top = "-999999px";
                    document.body.appendChild(textArea);
                    textArea.focus();
                    textArea.select();
                    document.execCommand("copy");
                    textArea.remove();
                  }

                  // 顯示成功提示
                  const toast = document.getElementById("toast");
                  toast.style.opacity = "1";
                  toast.style.pointerEvents = "auto";

                  setTimeout(() => {
                    toast.style.opacity = "0";
                    toast.style.pointerEvents = "none";
                  }, 3000);
                } catch (err) {
                  console.error("Could not copy text: ", err);
                  alert("Failed to copy content");
                }
              });
            });
          }

          // 初始化輪播功能
          initializeCarousel() {
            const carousels = document.querySelectorAll(".carousel-container");
            if (!carousels) return;

            carousels.forEach((carousel) => {
              const items = carousel.querySelectorAll(".carousel-item");
              const dots = carousel.querySelectorAll(".carousel-dot");
              const prevBtn = carousel.querySelector(".carousel-prev");
              const nextBtn = carousel.querySelector(".carousel-next");
              let currentIndex = 0;

              function showSlide(index) {
                items.forEach((item) => item.classList.add("opacity-0"));
                dots.forEach((dot) => dot.classList.add("opacity-50"));

                items[index].classList.remove("opacity-0");
                dots[index].classList.remove("opacity-50");
                currentIndex = index;
              }

              if (prevBtn && nextBtn) {
                prevBtn.addEventListener("click", () => {
                  const newIndex =
                    (currentIndex - 1 + items.length) % items.length;
                  showSlide(newIndex);
                });

                nextBtn.addEventListener("click", () => {
                  const newIndex = (currentIndex + 1) % items.length;
                  showSlide(newIndex);
                });
              }

              dots.forEach((dot) => {
                dot.addEventListener("click", () => {
                  const index = parseInt(dot.getAttribute("data-index"));
                  showSlide(index);
                });
              });
            });
          }

          // 初始化下��功能
          initializeDownload() {
            document.querySelectorAll(".download-all-btn").forEach((button) => {
              button.addEventListener("click", async function () {
                try {
                  const imagesData = JSON.parse(
                    this.getAttribute("data-images")
                  );

                  for (const imageData of imagesData) {
                    const response = await fetch(imageData.url);
                    const blob = await response.blob();

                    // 創建下載連結
                    const downloadLink = document.createElement("a");
                    downloadLink.href = URL.createObjectURL(blob);
                    downloadLink.download = imageData.filename;

                    // 觸發下載
                    document.body.appendChild(downloadLink);
                    downloadLink.click();
                    document.body.removeChild(downloadLink);

                    // 釋放 URL 對象
                    URL.revokeObjectURL(downloadLink.href);
                  }
                } catch (error) {
                  console.error("Download failed:", error);
                  alert("Failed to download images");
                }
              });
            });
          }
        }

        // 創建 PostManager 實例
        const postManager = new PostManager();
      });
    </script>
  </body>
</html>
{% endblock %}
